<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLOW | NETRUNNER TERMINAL</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="reset-modal.css">
    <link rel="stylesheet" href="university-modal-styles.css">
    <!-- RPM styles removed - using minimal integration -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&family=Share+Tech+Mono&display=swap"
        rel="stylesheet">
    <!-- Google Model-Viewer for 3D avatar display (better GLB compatibility than Three.js) -->
    <!-- Downgraded to 3.1.1 for stability/compatibility -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.1.1/model-viewer.min.js"></script>
</head>

<body class="profile-layout">

    <!-- SIDEBAR NAVIGATION (Minimized) -->
    <nav class="cyber-sidebar">
        <a href="index.html" class="cyber-nav-btn home-btn" title="RETURN TO GRID"><i
                class="fa-solid fa-house-signal"></i></a>
        <div class="nav-divider"></div>

        <!-- User Avatar with Dropdown -->
        <div class="sidebar-user-avatar-container" style="position: relative;">
            <img src="https://via.placeholder.com/50" alt="User" class="sidebar-user-avatar" id="sidebar-avatar"
                title="User Profile">
            <div class="dropdown-menu" id="sidebar-dropdown"
                style="display: none; position: absolute; left: 60px; top: 0; background: rgba(0,255,255,0.1); border: 1px solid #00ffff; padding: 10px; min-width: 200px; z-index: 1000;">
                <a href="channel.html" class="dropdown-item"
                    style="display: block; color: #00ffff; padding: 8px; text-decoration: none; border-bottom: 1px solid rgba(0,255,255,0.2);">
                    <div class="item-content">
                        <span class="item-title" style="display: block; font-weight: bold; font-size: 11px;">BROADCAST
                            FEED</span>
                        <span class="item-desc" style="display: block; font-size: 9px; opacity: 0.7;">>> Connect to live
                            channel stream</span>
                    </div>
                </a>
                <a href="terminal.html" class="dropdown-item"
                    style="display: block; color: #00ffff; padding: 8px; text-decoration: none; border-bottom: 1px solid rgba(0,255,255,0.2);">
                    <div class="item-content">
                        <span class="item-title" style="display: block; font-weight: bold; font-size: 11px;">OPERATOR
                            TERMINAL</span>
                        <span class="item-desc" style="display: block; font-size: 9px; opacity: 0.7;">>> Stream
                            dashboard & parameters</span>
                    </div>
                </a>
                <a href="subscriptions.html" class="dropdown-item"
                    style="display: block; color: #00ffff; padding: 8px; text-decoration: none; border-bottom: 1px solid rgba(0,255,255,0.2);">
                    <div class="item-content">
                        <span class="item-title"
                            style="display: block; font-weight: bold; font-size: 11px;">SUBSCRIPTIONS & FEEDS</span>
                        <span class="item-desc" style="display: block; font-size: 9px; opacity: 0.7;">>> Network
                            connections & followers</span>
                    </div>
                </a>
                <a href="profile.html" class="dropdown-item"
                    style="display: block; color: #00ffff; padding: 8px; text-decoration: none; border-bottom: 1px solid rgba(0,255,255,0.2);">
                    <div class="item-content">
                        <span class="item-title" style="display: block; font-weight: bold; font-size: 11px;">OPERATOR
                            DOSSIER</span>
                        <span class="item-desc" style="display: block; font-size: 9px; opacity: 0.7;">>> View operative
                            profile data</span>
                    </div>
                </a>
                <a href="settings.html" class="dropdown-item"
                    style="display: block; color: #00ffff; padding: 8px; text-decoration: none; border-bottom: 1px solid rgba(0,255,255,0.2);">
                    <div class="item-content">
                        <span class="item-title" style="display: block; font-weight: bold; font-size: 11px;">OPERATOR
                            SETTINGS</span>
                        <span class="item-desc" style="display: block; font-size: 9px; opacity: 0.7;">>> System config &
                            preferences</span>
                    </div>
                </a>
                <a href="javascript:void(0)" class="dropdown-item kill-signal" id="sidebar-sign-out"
                    style="display: block; color: #ff0000; padding: 8px; text-decoration: none;">
                    <div class="item-content">
                        <span class="item-title" style="display: block; font-weight: bold; font-size: 11px;">KILL
                            SIGNAL</span>
                        <span class="item-desc" style="display: block; font-size: 9px; opacity: 0.7;">>> Terminate
                            Session & Erasure</span>
                    </div>
                </a>
            </div>
        </div>

        <!-- Netrunner University Icon -->
        <button id="university-btn" class="cyber-nav-btn university-icon" title="Netrunner University">
            <div class="flowcard-icon">
                <i class="fa-solid fa-graduation-cap"></i>
                <span class="flowcard-badge" id="university-badge">0</span>
            </div>
        </button>

        <!-- FLOW CARD Icon -->
        <button id="flowcard-btn" class="cyber-nav-btn flowcard-icon" title="FLOWBANK">
            <div class="flowcard-icon">
                <i class="fa-solid fa-credit-card"></i>
                <span class="flowcard-badge" id="flowcard-badge">0</span>
            </div>
        </button>

        <button class="cyber-nav-btn active" title="OPERATOR DOSSIER"><i class="fa-solid fa-id-card"></i></button>
        <a href="subscriptions.html" class="cyber-nav-btn" title="SUBSCRIPTIONS & FEEDS"><i
                class="fa-solid fa-users"></i></a>
        <a href="settings.html" class="cyber-nav-btn" title="OPERATOR SETTINGS"><i class="fa-solid fa-gear"></i></a>
        <a href="terminal.html" class="cyber-nav-btn" title="OPERATOR TERMINAL"><i class="fa-solid fa-terminal"></i></a>
        <a href="channel.html" class="cyber-nav-btn" title="BROADCAST FEED"><i
                class="fa-solid fa-broadcast-tower"></i></a>
        <div class="nav-spacer"></div>
        <button class="cyber-nav-btn save-btn" id="global-save-btn" title="SAVE DATA"><i
                class="fa-solid fa-floppy-disk"></i></button>
    </nav>

    <!-- MAIN GRID CONTAINER -->
    <main class="mainframe-grid">

        <!-- LEFT: HOLO-DECK PREVIEW -->
        <section class="holo-deck">
            <div class="holo-header">
                <i class="fa-solid fa-eye"></i> <span>PUBLIC_FEED_PREVIEW</span>
                <div class="live-indicator">LIVE</div>
            </div>
            <div class="holo-viewport">
                <!-- Glitch Overlay -->
                <div class="scanline-overlay"></div>
                <!-- The Iframe -->
                <iframe id="dossier-frame" sandbox="allow-scripts allow-same-origin"></iframe>
            </div>
            <div class="holo-footer">
                <span class="sys-msg">RENDERING: OK</span>
                <span class="sys-msg">CONNECTION: SECURE</span>
            </div>
        </section>

        <!-- RIGHT: MAINFRAME EDITOR -->
        <section class="mainframe-terminal">

            <!-- Terminal Header -->
            <div class="terminal-header">
                <div class="term-title">
                    <i class="fa-solid fa-terminal"></i> <span>ROOT_ACCESS // EDIT_PROFILE</span>
                </div>
                <div class="term-controls">
                    <button id="mode-visual" class="term-tab active">VISUAL_EDITOR</button>
                    <button id="mode-code" class="term-tab">SOURCE_CODE</button>
                </div>
            </div>

            <!-- VISUAL EDITOR PANEL -->
            <div id="panel-visual" class="terminal-panel active">
                <div class="panel-scroll">

                    <!-- Identity Module -->
                    <div class="cyber-module">
                        <div class="module-header">:: IDENTITY_MATRIX</div>
                        <div class="input-grid-2">
                            <div class="cyber-input-group">
                                <label>CODENAME</label>
                                <input type="text" id="reg-username" class="cyber-input" placeholder="ENTER NAME">
                            </div>
                            <div class="cyber-input-group">
                                <label>CLEARANCE_LEVEL</label>
                                <input type="text" id="reg-level" class="cyber-input short" placeholder="LVL" readonly
                                    style="cursor: not-allowed; opacity: 0.7;">
                            </div>
                        </div>
                    </div>

                    <!-- Achievement Tracker Module -->
                    <div class="cyber-module achievement-tracker" id="achievement-tracker">
                        <div class="module-header">:: ACHIEVEMENT_TRACKER <span class="expand-hint">CLICK TO
                                EXPAND</span></div>
                        <div class="stats-readout">
                            <div class="stat-line" data-tier="affiliate">
                                <span class="stat-name" id="affiliate-label" style="color:#fff;">AFFILIATE</span>
                                <div class="stat-track">
                                    <div class="stat-fill" id="affiliate-bar" style="width:0%; background:#0ff;"></div>
                                </div>
                            </div>
                            <div class="stat-line" data-tier="verified">
                                <span class="stat-name" id="verified-label" style="color:#fff;">VERIFIED</span>
                                <div class="stat-track">
                                    <div class="stat-fill" id="verified-bar" style="width:0%; background:#ff0055;">
                                    </div>
                                </div>
                            </div>
                            <div class="stat-line" data-tier="partner">
                                <span class="stat-name" id="partner-label" style="color:#fff;">PARTNER</span>
                                <div class="stat-track">
                                    <div class="stat-fill" id="partner-bar" style="width:0%; background:#00ff88;"></div>
                                </div>
                            </div>
                            <div class="stat-line">
                                <span class="stat-name" style="color:#fff;">CHATTER</span>
                                <div class="stat-track">
                                    <div class="stat-fill" id="chatter-fill"
                                        style="width:0%; background:#ffff00; transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                        </div>
                        <!-- Expand Arrow -->
                        <div class="tracker-expand-arrow" id="tracker-arrow">
                            <i class="fa-solid fa-chevron-down"></i>
                        </div>

                        <!-- Expandable Dropdown Panel -->
                        <div class="achievement-dropdown" id="achievement-dropdown">
                            <div class="achievement-content" id="achievement-content">
                                <!-- Content populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Interface Theme Module -->
                    <div class="cyber-module">
                        <div class="module-header">:: INTERFACE_COLOR</div>
                        <div class="color-selector">
                            <input type="color" id="reg-color" class="cyber-color-input">
                            <span id="color-val-display">#00FFFF</span>
                        </div>
                    </div>

                    <!-- Avatar Source -->
                    <div class="cyber-module">
                        <div class="module-header">:: AVATAR_SOURCE</div>
                        <div class="input-group-row">
                            <input type="text" id="reg-avatar" class="cyber-input" placeholder="IMAGE_URL_OR_PATH">
                            <label for="file-upload" class="cyber-btn-icon"><i class="fa-solid fa-upload"></i></label>
                            <input type="file" id="file-upload" hidden>
                        </div>
                    </div>


                    <!-- Ready Player Me Avatar Customization -->
                    <div class="cyber-module">
                        <div class="module-header">
                            :: 3D_AVATAR_MATRIX
                            <span class="avatar-help-icon" onclick="toggleAvatarHelp()" title="Help">
                                <i class="fa-solid fa-circle-question"></i>
                            </span>
                        </div>
                        <div id="avatarHelpBox" class="avatar-help-box" style="display: none;">
                            <strong>Avatar Editor Not Working?</strong><br>
                            If you see a random character instead of customization options:<br>
                            1. Click the lock icon in your browser's address bar<br>
                            2. Allow cookies and site data<br>
                            3. Refresh the page<br>
                            <em>Or try using Chrome for the best experience.</em>
                        </div>
                        <div class="avatar-showcase-rpm">
                            <div class="avatar-preview-3d" id="avatarPreviewContainer">
                                <img id="profileAvatar"
                                    src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect fill='%23000' width='200' height='200'/%3E%3Cpath fill='%2300ffff' d='M100 50c-16.5 0-30 13.5-30 30s13.5 30 30 30 30-13.5 30-30-13.5-30-30-30zm0 120c-33.1 0-60-26.9-60-60h120c0 33.1-26.9 60-60 60z'/%3E%3Ctext x='100' y='190' text-anchor='middle' fill='%2300ffff' font-family='Orbitron' font-size='12'%3ENo Avatar%3C/text%3E%3C/svg%3E"
                                    alt="Avatar" style="display: none;" onerror="this.style.display='none';">
                            </div>
                            <!-- Ready Player Me Avatar Creation -->
                            <button class="avatar-action-btn" onclick="openPlayerZeroCreator()">
                                <i class="fa-solid fa-user-astronaut"></i> Create Ready Player Me Avatar
                            </button>

                            <button class="avatar-action-btn" onclick="openVIVERSECreator()" style="margin-top: 10px;">
                                <i class="fa-solid fa-cube"></i> Create VIVERSE Avatar
                            </button>

                            <!-- VRM Upload -->
                            <input type="file" accept=".vrm" id="vrm-upload" style="display: none;">
                            <button class="avatar-action-btn" onclick="document.getElementById('vrm-upload').click()"
                                style="margin-top: 10px;">
                                <i class="fa-solid fa-upload"></i> Upload VRM Avatar
                            </button>

                            <!-- Ready Player Me ID Input -->
                            <div
                                style="margin-top: 15px; padding: 15px; border: 1px solid #00ffff; border-radius: 5px; background: rgba(0,255,255,0.05);">
                                <label
                                    style="color: #00ffff; font-family: 'Orbitron', sans-serif; font-size: 11px; display: block; margin-bottom: 8px; line-height: 1.4;">
                                    AFTER CREATING ON READY PLAYER ME:<br>
                                    1. Copy ID from URL (after "id=")<br>
                                    2. Paste below and click Load
                                </label>
                                <input type="text" id="playerzero-id" placeholder="Paste Ready Player Me Avatar ID"
                                    style="width: 100%; padding: 8px; background: #000; border: 1px solid #00ffff; color: #00ffff; font-family: 'Share Tech Mono', monospace; margin-bottom: 8px;">
                                <button class="avatar-customize-btn" onclick="loadPlayerZeroAvatar()"
                                    style="width: 100%;">
                                    <i class="fa-solid fa-download"></i> Load Avatar
                                </button>
                            </div>
                            <button class="avatar-action-btn danger" onclick="clearAvatar()" style="margin-top: 10px;">
                                <i class="fa-solid fa-trash"></i> Clear Avatar
                            </button>

                            <!-- 3D Avatar Display (spinning model) -->
                            <div id="avatar-3d-container"
                                style="width: 100%; height: 650px; margin-top: 20px; border: 2px solid #00ffff; border-radius: 10px; background: #0a0a0a; display: none;">
                            </div>
                            <!-- Fallback displays (hidden by default) -->
                            <model-viewer id="avatar-model-viewer" style="display: none;"></model-viewer>
                            <iframe id="rpm-avatar-viewer" style="display: none;"></iframe>
                        </div>
                    </div>

                    <!-- Bio Module -->
                    <div class="cyber-module">
                        <div class="module-header">:: BIOGRAPHICAL_DATA</div>
                        <textarea id="reg-bio" class="cyber-textarea" rows="4" maxlength="250"
                            placeholder="ENTER_HISTORY..."></textarea>
                    </div>

                    <!-- Social Links Module -->
                    <div class="cyber-module">
                        <div class="module-header">:: UPLINKS</div>
                        <div class="social-inputs">
                            <input type="text" id="reg-soc-x" class="cyber-input" placeholder="X_UPLINK">
                            <input type="text" id="reg-soc-insta" class="cyber-input" placeholder="INSTA_UPLINK">
                            <input type="text" id="reg-soc-tiktok" class="cyber-input" placeholder="TIKTOK_UPLINK">
                            <input type="text" id="reg-soc-snap" class="cyber-input" placeholder="SNAP_UPLINK">
                            <input type="text" id="reg-soc-yt" class="cyber-input" placeholder="YT_UPLINK">
                            <input type="text" id="reg-soc-discord" class="cyber-input" placeholder="DISCORD_UPLINK">
                        </div>
                        <div class="module-header sub">:: CUSTOM_PROTOCOLS</div>
                        <div class="social-inputs">
                            <input type="text" id="reg-custom-1" class="cyber-input" placeholder="CUSTOM_LINK_1">
                            <input type="text" id="reg-custom-2" class="cyber-input" placeholder="CUSTOM_LINK_2">
                            <input type="text" id="reg-custom-3" class="cyber-input" placeholder="CUSTOM_LINK_3">
                        </div>
                    </div>

                    <div class="panel-footer">
                        <button type="button" id="reset-template-btn" class="cyber-btn danger">
                            <i class="fa-solid fa-triangle-exclamation"></i> SYSTEM_RESET
                        </button>
                    </div>

                </div>
            </div>

            <!-- CODE EDITOR PANEL (Hidden) -->
            <div id="panel-code" class="terminal-panel">
                <div class="code-tabs">
                    <button class="code-tab active" data-target="editor-html">HTML</button>
                    <button class="code-tab" data-target="editor-css">CSS</button>
                    <button class="code-tab" data-target="editor-js">JS</button>
                    <button class="code-tab" data-target="editor-data">DATA</button>
                    <div class="spacer"></div>
                    <button id="compile-btn" class="code-action"><i class="fa-solid fa-play"></i> EXECUTE</button>
                </div>

                <div class="code-viewport">
                    <div id="editor-html" class="code-box active"><textarea spellcheck="false"></textarea></div>
                    <div id="editor-css" class="code-box"><textarea spellcheck="false"></textarea></div>
                    <div id="editor-js" class="code-box"><textarea spellcheck="false"></textarea></div>
                    <div id="editor-data" class="code-box"><textarea spellcheck="false"></textarea></div>
                    <!-- config hidden for now simplicity -->
                    <div id="editor-configs" style="display:none;"><textarea></textarea></div>
                </div>
            </div>

        </section>

    </main>

    <!-- Custom Reset Confirmation Modal -->
    <div id="reset-modal-overlay" class="reset-modal-overlay">
        <div class="reset-modal">
            <div class="reset-modal-title">⚠️ SYSTEM RESET</div>
            <div class="reset-modal-message">
                This will restore the default template and erase all custom code.<br>
                This action cannot be undone.<br><br>
                <strong>Continue?</strong>
            </div>
            <div class="reset-modal-buttons">
                <button id="reset-modal-confirm" class="reset-modal-btn reset-modal-confirm">
                    CONFIRM RESET
                </button>
                <button id="reset-modal-cancel" class="reset-modal-btn reset-modal-cancel">
                    CANCEL
                </button>
            </div>
        </div>
    </div>

    <!-- Main Script (MUST load first) -->
    <script src="script.js"></script>

    <!-- Credit System Scripts (load after main script) -->
    <script src="points-system.js"></script>
    <script src="flowbank-system.js"></script>
    <script src="netrunner-university.js"></script>
    <script src="bounty-watch-system.js"></script>
    <script src="integration-fixes.js"></script>
    <script src="credit-system-ui.js"></script>
    <script src="profile-sync.js"></script>

    <!-- Ready Player Me - Fixed with Workarounds -->
    <script src="avatar-rpm-fixed.js"></script>

    <!-- VIVERSE Avatar SDK - Hybrid CDN Integration -->

    <!-- VIVERSE SDK -->
    <script src="https://www.viverse.com/static-assets/viverse-sdk/index.umd.cjs"></script>

    <!-- Three.js - ONLY use ES Modules to prevent dual-loading conflicts -->
    <!-- UPGRADED to 0.170.0 to fix GLB bufferView parsing bug -->
    <!-- GLTFLoader - using importmap for ES modules -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
        }
    }
    </script>

    <!-- VRM Loader and GLTFLoader as module -->
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
        import { VRMLoaderPlugin } from 'https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@3.0.0/lib/three-vrm.module.js';

        // Set up DRACO decoder for compressed meshes (used by Ready Player Me)
        const dracoLoader = new DRACOLoader();
        dracoLoader.setDecoderPath('https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/libs/draco/');

        // Create GLTFLoader with DRACO support
        const gltfLoader = new GLTFLoader();
        gltfLoader.setDRACOLoader(dracoLoader);

        // Expose to global scope - SINGLE source of truth
        window.THREE = THREE;
        window.GLTFLoader = GLTFLoader;
        window.DRACOLoader = DRACOLoader;
        window.configuredGLTFLoader = gltfLoader;  // Pre-configured with DRACO
        window.VRMLoaderPlugin = VRMLoaderPlugin;

        console.log('✅ Three.js v0.170.0 loaders ready (unified module + DRACO)');
    </script>

    <!-- Our VIVERSE integration -->
    <script src="avatar-viverse.js"></script>
</body>

</html>